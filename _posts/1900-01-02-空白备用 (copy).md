---
layout:     post
title:      网站重构
subtitle:   备用
date:       1900-01-01
author:     Rainsblue.chan
header-img: ![3](../../../wallpaper/3.jpg)
catalog:   true
tags:
    - 经验
---

## 网站重构

### 选择centos7-minimal版本，进行宝塔面板下载

[镜像链接](https://mirrors.tuna.tsinghua.edu.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso)

<img src="C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230826001304258.png" alt="image-20230826001304258" style="zoom:33%;" />

<img src="C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230826001516080.png" alt="image-20230826001516080" style="zoom:33%;" />

#### 系统的root账密与用户账密

root toor

liuhan 1234

![image-20230826002240673](C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230826002240673.png)

#### 如遇到进程占用请用下列命令

`kill -9 进程pid`

![image-20230825223958937](C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230825223958937.png)

#### 防保护机制（修改/etc/ssh/sshd_config文件）

使用命令打开/etc/ssh/sshd_config文件：

`vi /etc/ssh/sshd_config`，修改两个参数`ClientAliveInterval`和`ClientAliveCountMax`，这两个参数控制了客户端的存活检测间隔和失败检测的最大次数，如果超过了这个次数就断开客户端的连接，默认情况下这两个是未开启的，将其修改为60和5，值自己定.

ClientAliveInterval 100	ClientAliveCountMax 1512

### <img src="C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230826002527601.png" alt="image-20230826002527601" style="zoom: 50%;" />

#### 网络重启

![image-20230827143440278](C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230827143440278.png)

`service network restart`

#### 下载指令

`yum install -y wget && wget -O install.sh http://download.bt.cn/install/install_6.0.sh && sh install.sh`

跟着一步步走就行，最好选择美国节点的vpn，下载速度非常快

<img src="C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230826002812773.png" alt="image-20230826002812773" style="zoom:50%;" />

#### 宝塔面板的账密

![image-20230826003751550](C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230826003751550.png)

外网面板地址: https://114.84.196.106:30591/c05866e9
内网面板地址: https://192.168.88.145:30591/c05866e9
username: zbv79oyg
password: 9ffd042b

进去后改一个好用的账密

liuhan 123456

### 配置宝塔面板

<img src="C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230826004324164.png" alt="image-20230826004324164" style="zoom:50%;" />

进去面板之后记得下载插件，我就用LNMP，感觉比较方便，然后改完账密记得一个重要操作，就是快照，它相当于gba的存档，保存一个状态，非常重要。

### 快照

![image-20230826010926986](C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230826010926986.png)

### 小技巧

面板一般开两个

<img src="C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230826011936386.png" alt="image-20230826011936386" style="zoom:50%;" />

### BT面板，服务器搭建

#### bt 14 & bt5

![image-20230827140311028](C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230827140311028.png)

![image-20230827140335465](C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230827140335465.png)

![image-20230827140356134](C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230827140356134.png)

### 阿里调证（2023蓝帽杯）

[阿里云“.xb”数据库物理备份文件本地重建](https://goyasha.com/post/Ns1AaO0d/)

#### 注意！

先把服务器搭起来，再放数据库。

#### 在宝塔界面准备一个ceshi文件夹，上传xb文件

![image-20230827141226992](C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230827141226992.png)

#### 安装转换xb文件必要的软件（注意安装Mysql 5.5/6/7）

进入终端

![image-20230827141855703](C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230827141855703.png)



```
// 获取xtrabackup
[root@localhost ~]# wget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.9/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.9-1.el7.x86_64.rpm
...
// 安装xtrabackup
[root@localhost ~]#  yum install -y percona-xtrabackup-24-2.4.9-1.el7.x86_64.rpm
...
// 安装qpress
[root@localhost ~]# wget "http://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/attach/183466/cn_zh/1608011575185/qpress-11-linux-x64.tar"

[root@localhost ~]# tar xvf qpress-11-linux-x64.tar

[root@localhost ~]# chmod 775 qpress
[root@localhost ~]# cp qpress /usr/bin
```

#### 解压xb包文件

```
// 命令：cat <数据备份文件名> | xbstream -x -v -C <解压目录>
[root@localhost ~]# cat /www/ceshi/xb文件名 | xbstream -x -v -C /www/data

// 上面解包后再进行解压
[root@localhost ~]# innobackupex --decompress --remove-original /www/data
```

### 按照官方的意思是解压下来还需要再次解压，否则是不能用的。

```
// 再一次解压
[root@localhost ~]# innobackupex --defaults-file=/www/data/backup-my.cnf --apply-log /www/data
```

因为已经知道了是Mysql5.7的，准备直接将文件全部替换到 Mysql 下的 data 目录看看，但是可惜宝塔面板做了限制，不能直接对将文件复制到 Mysql Data 下。

## 重现，网站重构

### 数据库配置

进入到server目录，放置压缩包

![image-20230825214034169](https://cdn.jsdelivr.net/gh/rainsbluechan/blogimage@main/img/image-20230825214034169.png)

### 进入终端解压缩（tar -cvf）

`tar -cvf 文件名 目标地址/`

![image-20230825214154433](https://cdn.jsdelivr.net/gh/rainsbluechan/blogimage@main/img/image-20230825214154433.png)

### 关一下mysqld服务

`systemctl stop mysqld`

![image-20230825214351404](C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230825214351404.png)

### 删除数据库特定文件

` rm -rf ibdata1 ib_logfile* mysql-bin.00000*`

![image-20230825214602346](C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230825214602346.png)

![image-20230825214654039](C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230825214654039.png)

### echo（检验是否删除干净二进制信息）

`echo > mysql-bin.index`

![image-20230825214753257](C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230825214753257.png)

`cat mysql-bin.index`

![image-20230825214931560](C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230825214931560.png)

### 根目录下用xvf再解压一遍

![image-20230825215544074](C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230825215544074.png)

### 复制到目标目录

`cp ibdata1 ib_logfile* /www/server/data`

如果磁盘空间不够使用df -h查看

`cp -r 目标文件/ /www/server/data  `

注意文件夹一定要带一个/

### 重启mysql

![image-20230825220744032](C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230825220744032.png)

#### Job for mysqld.service failed because the control process exited with error code. See "systemctl status mysqld.service" and "journalctl -xe" for details.

[Job for mysqld.service failed because the control process exited with error code.](https://blog.csdn.net/yujinlong2002/article/details/128555984)

##### 先查询一下mysql的进程

`ps -aux|grep mysql`

![image-20230827144901284](C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230827144901284.png)

##### 把红框进程杀掉

`kill -9 进程pid`

关于Job for mysqld.service failed because the control process exited with error code[报错解决办法](https://blog.csdn.net/qq_58281481/article/details/126830726)

##### 先进入指定目录/run,在这个目录下创建一个mysqld文件，再对此文件授权，这样就能 正常启动mysql服务了

```
cd /run
ls
mkdir mysqld
chown -R mysql:mysql /run/mysqld
systemctl start mysqld
```

[mysql报错无法启动解决方法](https://blog.csdn.net/qq_30817059/article/details/125990556)

### 重启（权限）

![image-20230827150539843](C:/Users/14682/AppData/Roaming/Typora/typora-user-images/image-20230827150539843.png)

进入server文件夹

`chown -R mysql:mysql data`

再重启





